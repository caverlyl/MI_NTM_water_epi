---
title: "A retrospective analysis of NTM infection and monochloramine disinfection of municipal drinking water in MI "
author: "Nadine Kotlarz"
date: "March 7, 2019"
output: word_document
---

# Libraries
```{r setwd, eval=F}

knitr::opts_knit$set(root.dir = "C:/Users/nkotlar/Documents/Research/RESULTS/NTM_EPI/Rmarkdown")

#data wrangling
library(dplyr)
#install.packages("tidyr")
library(tidyr)
library(stringr)
library(stringi)
library(knitr)

#for loops
#install.packages("doParallel")
library(doParallel)
#install.packages("data.table")
library(data.table)

#mapping
#install.packages("gmapsdistance")
library(gmapsdistance)
#install.packages("ggmap")
library(ggmap)
#install.packages("maptools")
library(maptools)
#install.packages("rgeos")
library(rgeos) #needed for gContains command

#plotting
library(ggplot2)
#install.packages("rgdal")
library(rgdal)
library(scales)

#modeling
#install.packages("lme4")
library(lme4)

#matching
#install.packages("MatchIt")
#install.packages("optmatch")
library(MatchIt)
library(optmatch)
library(RItools) #visualizing how well matching performed
#install.packages("glmnet")
library(glmnet)

#install.packages("XML")
library(XML)
library(RCurl)

#install.packages("lsmeans")
library(lsmeans)

#install.packages("oddsratio")
library(oddsratio)

library(xlsx)
```
# Settings
```{r setup, include=FALSE, eval=F}
knitr::opts_chunk$set(echo = FALSE)
```


# Filtering records

## 1. Create sample source groups /records
```{r create_source_groups, echo=F, warning=FALSE, include=FALSE, eval=FALSE}

   Old<-Sys.time()

# # Read in clinical file
   clinical<-read.csv("full_dataset_with_clinical_without_speciesid_inference.csv", 
                      header=T, 
                      row.names=1, 
                      na.strings="NA", 
                      colClasses=rep("character",8))
 
   # check file
   length(unique(clinical$study_id))                                     #29,942 patients
   length(unique(clinical$sample_id))                                    #61,786 records
   length(unique(filter(clinical, result=="positive")$sample_id))        #2470 positives
   length(unique(filter(clinical, result=="negative")$sample_id))        #58910 negatives
   length(unique(filter(clinical, result=="unknown")$sample_id))         #406 unknowns
 
 # Remove all unknown results from dataset
     
   clinical<-filter(clinical, result=="positive" | result=="negative")   #remove all unknown results
 
   # check file
   length(unique(clinical$study_id))                                     #29,891 patients
   length(unique(clinical$sample_id))                                    #61,380 records
   length(unique(filter(clinical, result=="positive")$sample_id))        #2470
   length(unique(filter(clinical, result=="negative")$sample_id))        #58910
 
 # Make result binary (positive=1, negative=0)
     
   clinical$result<-sapply(clinical$result,function(x){gsub("negative","0",ignore.case=T,x)}) #make binary
   clinical$result<-sapply(clinical$result,function(x){gsub("positive","1",ignore.case=T,x)}) #make binary
   clinical$result<-as.factor(clinical$result) #make factor
   
     
 # Create source groups for positive cultures
 
   clinical$source_group<-clinical$source                                #copy source column over to another column
    
   # 1. lung
   clinical$source_group<-sapply(clinical$source_group,function(x){gsub("(SPUT|SPUTUM|BRONCHIAL WA|ENDOTRACHEAL|BRONCHO-ALVE|BAL|TRACHEAL ASP|BRON BX|BRWSH|SPUTUM, INDU|CHEST|BRONCH|BRONCHI|BRONCHI, LEF|THORACENTESI|BRONCH BRUSH|PLEURAL FLUI|BRONCHIAL BI|LUNG|LUNG R|LUNG RUL|RIGHT LUNG|LUNG LLL|LUNG RLL|LUNG L|LEFT LUNG|RIGHT LUNG|LUNG LUL|LEFT LUNG, U|LEFT LUNG, L)","Lung",ignore.case=T,x)})
 
   # 2. gastrointestinal
   clinical$source_group<-sapply(clinical$source_group,function(x){gsub("(ABDOMINAL FL|PERITONEAL F|PERITONEAL D|FECES|ABDFL|DUODENAL ASP|GASTRIC FLUI|ULCER|PARACENTESIS)","Gastrointestinal",ignore.case=T,x)})
    
   # 3. lymphatic
   clinical$source_group<-sapply(clinical$source_group,function(x){gsub("(LYMPH NODE|NODE)","Lymphatic",ignore.case=T,x)})
    
   # 4. blood
   clinical$source_group<-sapply(clinical$source_group,function(x){gsub("(BONE MARROW|BLD|BLOOD)","Blood",ignore.case=T,x)})
    
   # 5. skin and musculoskeletal
   clinical$source_group<-sapply(clinical$source_group,function(x){gsub("(SYNOVIUM|STERNAL|STERNUM|FINGER|BONE|RIGHT LEG|WOUND|SYNFL|SKIN|TENDON|FOREARM|GROIN|WRIST R|WRIST L|RIGHT WRIST|LEFT WRIST|WRIST|FING|BURSA|HAND L|RIGHT HAND|HAND|HAND R|LEFT HAND|NECK|LEFT ARM|ARM L|ARM R|ARM|RIGHT ARM|RIGHT CHEEK|MOUTH|SYNOVIAL FLU)","Skin and Musculoskeletal",ignore.case=T,x)})
    
   # 6. other
   clinical$source_group<-sapply(clinical$source_group,function(x){gsub("(TISSUE|BF|FLUID|BIOPSY|ABSCESS|MASS|PUS|JACKSON PRAT|OTHER|SWAB OF UNKN|ASPIRATE|BODY FLUID|CYST|DIALYSATE|PAROTID|DRAINAGE|LUMBAR|FOREIGN BODY|BRBR|CATHETER TIP)","Other",ignore.case=T,x)})
    
   # 7. sinus
   clinical$source_group<-sapply(clinical$source_group,function(x){gsub("(NASAL|MAXILLARY SI|SINUS|RIGHT MAXILL|LEFT MAXILLA|MAXILLARY|MAXILLAR)","Sinus",ignore.case=T,x)})
    
    
   # 8. central nervous system
   clinical$source_group<-sapply(clinical$source_group,function(x){gsub("(CEREBROSPINA)","Central Nervous System",ignore.case=T,x)})
    
   # 9. genitourinary
   clinical$source_group<-sapply(clinical$source_group,function(x){gsub("(UR|URINE)","Genitourinary",ignore.case=T,x)})
 
    
 # Check all positives
   
   positives<-filter(clinical, result=="1")             #get positives
   length(unique(positives$sample_id))                  #2470 positive records
   length(unique(positives$source_group))               #10 categories including unknown
   length(unique(positives$study_id))                   #1520 patients with a positive test
   

   New<-Sys.time()
   New-Old #1.456135 mins
  
  write.table(clinical, "clinical.txt")
  read.table("clinical.txt", sep="\t")

```

## 2. Remove gordonae contaminants /records
```{r remove_gordonae_contaminants, echo=F, warning=FALSE, include=FALSE, eval=FALSE}
 
  Old<-Sys.time()
  
# Get gordonae cultures
  
  gordonae<-filter(positives, species=="gordonae")                                 #get all gordonae cultures
  nrow(gordonae) #487
  length(unique(gordonae$study_id)) #399
  
# Remove single gordonae cultures
  
  contaminants <- gordonae %>% group_by(study_id, source_group) %>% filter(n()==1) #single cultures
  nrow(contaminants) #357
  
  clinicalgood<-filter(clinical, !sample_id %in% contaminants$sample_id)
  nrow(clinical)                                                                   #61,380
  nrow(clinicalgood)                                                               #61,023

# Remove gordonae from unknown sites
  
  hold<-filter(clinicalgood, species=="gordonae" & source_group=="")$sample_id #hold sample ids
  clinicalgood<-filter(clinicalgood, !sample_id %in% hold)                     #filter for sample ids not in hold
  nrow(clinicalgood)                                                           #61,009 #14 records removed
  
#357 + 14 = 371 M. gordonae cultures removed
  
# check file

  length(unique(clinicalgood$study_id)) #29,789 patients
  length(unique(clinicalgood$sample_id)) #61,009 records
  length(unique(filter(clinicalgood, result=="1")$sample_id)) #2099 positives
  length(unique(filter(clinicalgood, result=="0")$sample_id)) #58910 negatives
  
  New<-Sys.time()
  New-Old #1.382149 secs

  #write.table(clinicalgood, "clinicalgood.txt")
  clinicalgood<-read.table("clinicalgood.txt", header=T)
  
```
## 3. Geocode record addr /records
```{r geocode_addr, eval=F}
 # Old<-Sys.time()
 # 
 #   #=========Read in files
 #   culture_addr<-read.csv(file="~/Box Sync/_1_Research/_07_Scripts_and_seqs/_01_Retrospective_study/_01_RMarkdown/addresses_with_study_id.csv", header=TRUE, sep = ",", na.strings="NA", check.names=FALSE, quote="\"", comment.char="", row.names=1)
 #   nrow(culture_addr) #61,786
 #   api_key<-scan(file="Google_API_key.txt", what="")
 #   api_key<-api_key[5]
 # 
 #   #=========Geocode culture addresses
 #   # Create empty vectors to hold geocoordinates
 #   geocode_lat<- numeric(nrow(culture_addr))
 #   geocode_lon<- numeric(nrow(culture_addr))
 #   geocode_locationType<-numeric(nrow(culture_addr))
 #   geocode_address<-numeric(nrow(culture_addr))
 #   geocode_type<-numeric(nrow(culture_addr))
 #   geocode_place_id<-numeric(nrow(culture_addr))
 # 
 #   # Create a function to geocode data
 #    getGeoData <- function(location, api_key){
 #      location <- gsub(' ','+',location)
 #      geo_data <- getURL(paste("https://maps.googleapis.com/maps/api/geocode/json?address=",location,sprintf("&key=%s",api_key), sep=""))
 #      geo_data <- fromJSON(geo_data)
 #      out <- c('lat'=NA,'lng'=NA, 'address' = NA, 'location_type' = NA,'type'= NA, 'place_id'=NA)
 #      try(out <- c(geo_data$results[[1]]$geometry$location,
 #                   geo_data$results[[1]]$formatted_address,
 #                   geo_data$results[[1]]$geometry$location_type,
 #                   geo_data$results[[1]]$types[1],
 #                   geo_data$results[[1]]$place_id)) #can use this to reverse geocode addresses to check geocoding
 #      return(out)
 #    }
 # 
 #   z<-nrow(culture_addr)
 #   #z<-10
 # 
 #    for (i in 1:z){
 #      location<-paste(culture_addr[i,2],culture_addr[i,4],culture_addr[i,5],culture_addr[i,6])
 #      location<-lapply(location,function(x){gsub("\\s+"," ",x)})
 #      geocode<-print(getGeoData(location,api_key))
 #      geocode_lat[i]<-geocode[1]
 #      geocode_lon[i]<-geocode[2]
 #      geocode_locationType[i]<-geocode[3]
 #      geocode_address[i]<-geocode[4]
 #      geocode_type[i]<-geocode[5]
 #      geocode_place_id[i]<-geocode[6]
 #    }
 # 
 #   geocode_lon<-as.data.frame(geocode_lon)
 #   geocode_lat<-as.data.frame(geocode_lat)
 #   geocode_locationType<-as.data.frame(geocode_locationType)
 #   geocode_address<-as.data.frame(geocode_address)
 #   geocode_type<-as.data.frame(geocode_type)
 #   geocode_place_id<-as.data.frame(geocode_place_id)
 # 
 #   geocoded<-bind_cols(geocode_lon,geocode_lat, geocode_locationType,geocode_address,geocode_type, geocode_place_id)
 #   geocoded<-bind_cols(culture_addr,geocoded)
  
  #=========Check results
#  nrow(geocoded) #61,786
#  geocoded_noNA<-geocoded %>% filter(!is.na(geocode_lon))
#  nrow(geocoded_noNA) #61,362
#  nogeocode<-geocoded %>% filter(is.na(geocode_lon))
#  nrow(nogeocode) #424 addresses cannot be geocoded (0.68%)
#  nrow(nogeocode)/nrow(geocoded)
  
#  nrow(filter(geocoded_noNA, geocode_address=="ROOFTOP"))/nrow(geocoded_noNA) #62.4%
#  nrow(filter(geocoded_noNA, geocode_address=="APPROXIMATE"))/nrow(geocoded_noNA) #1.98%
#  nrow(filter(geocoded_noNA, geocode_address=="RANGE_INTERPOLATED"))/nrow(geocoded_noNA) #34.2% 
#  nrow(filter(geocoded_noNA, geocode_address=="GEOMETRIC_CENTER"))/nrow(geocoded_noNA) #%1.48
  
#New<-Sys.time()
#New-Old #time to run the geocoding 7.654527 h

#geocoded<-read.table("geocoded_noNA.txt", header=T) #read in file with geocoded addr #only contains addr that could be geocoded
#length(unique(geocoded$sample_id)) #61362

```
## 4. Filter for record addr in cities /records
```{r, cities}

# Plot Michigan cities
    
#   dsn<-getwd()
#   ogrInfo(dsn=dsn,layer="Minor_Civil_Divisions_Cities__Townships_CITIES")
   #readOGR("Minor_Civil_Divisions_Cities__Townships_CITIES.shp") #shape file works
     
# Read in shape file and specify projection
     
#   cities<-readShapePoly("Minor_Civil_Divisions_Cities__Townships_CITIES",proj4string=CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))
   
 # Transform shape file
   
#   cities<-spTransform(cities, CRS("+proj=longlat +datum=WGS84 +no_defs"))
     
 # Plot 140 cities in Michigan
   
#   plot(cities)
      
# # Loop through addr and check against cities polygon
#   
#   # Subset geocoded file for records not identified as gordonae contaminants
#   
#   geocodedgood<-filter(geocoded, sample_id %in% clinicalgood$sample_id)
#     
#   # Parallelize the foreach loop
#    
#   Old<-Sys.time()
#   detectCores() #4
#   cl<-makeCluster(4)
#   registerDoParallel(cl)
#   export.names<-c("SpatialPoints","CRS", "gContains")
# 
#   # Foreach loop
#     
#   hits<-foreach (i=1:nrow(geocodedgood), .combine="c", .export=export.names) %dopar% {
#   p<-SpatialPoints(list(geocodedgood$geocode_lon[i],geocodedgood$geocode_lat[i]),proj4string=CRS("+proj=longlat +datum=WGS84 +no_defs"))
#     if(gContains(cities,p)==TRUE){"hit"} 
#     else {"nope"}
#   }
#     
#   stopCluster(cl)
#   New<-Sys.time()
#   New-Old #hours
#   
#   geocodedgood$hits<-hits
#   geocodedgoodcities<-filter(geocodedgood, hits=="hit") #filter for sample addr inside city limits
# 
# # Output file
# 
#   write.table(geocodedgoodcities, "geocodedgoodcities.txt")
#   
# # Read in file from a previous run
  
  geocodedgoodcities<-read.table("geocodedgoodcities.txt")
  length(unique(geocodedgoodcities$sample_id)) #25,256

```

## 5. Get distance to Michigan Medicine /records
```{r get_subject_distance}

 # Get distance to Michigan Medicine for each sample addr
   
 # Get Michigan Medicine geocoordinates
  
   MichiganMed<-geocode("1500 E. Medical Center Drive, Ann Arbor, MI", source="google", output="latlon")
   MichiganMed<-paste(MichiganMed$lat, MichiganMed$lon,sep="+")
   destination<-MichiganMed #rename as destination
     
   # Set api key
     
   api_key<-scan(file="Google_API_key.txt", what="")
   api_key<-api_key[5]
   set.api.key(api_key[5])
   
   # Run foreach loop    
   
   Old<-Sys.time()
    
     # Parallelize foreach loop to make loop faster
     
      Old<-Sys.time()
      detectCores() #4
      cl<-makeCluster(4)
      registerDoParallel(cl)
      export.names<-c("gmapsdistance2", "get.api.key", "xmlParse", "getURL", "xmlChildren", "xmlRoot", "xmlValue")  
    
     
     Old<-Sys.time()
     distances<-foreach (i=1:nrow(geocodedgoodcities), .combine="c", .export=export.names) %dopar% {
       origin<-paste(geocodedgoodcities$geocode_lat[i],geocodedgoodcities$geocode_lon[i],sep="+")
       hold<-gmapsdistance2(origin,destination, mode="driving", key=api_key)
       return(hold$Distance)
     }
     New<-Sys.time() #1.074688 hours
     New-Old
     stopCluster(cl)
     
     geocodedgoodcities$distance<-distances #distance returned in meters
     geocodedgoodcitiesdist<-geocodedgoodcities #rename
 
# Output file
 
#     write.table(geocodedgoodcitiesdist,"geocodedgoodcitiesdist.txt", sep="\t")
    
# Read in file from a previous run
    
#    geocodedgoodcitiesdist<-read.table("geocodedgoodcitiesdist.txt")
#    length(unique(geocodedgoodcitiesdist$sample_id)) #25256 #length should not change because just added dist
    
```


## 6. Filter for record addr in DWTP "service areas" /records
```{r}
# 
# # A "service area" is a *city* with known water treatment practices
# 
# # Read in service areas
# 
#   finalserviceareas<-read.table("finalserviceareas.txt", header=T) #140 service areas
#   finalserviceareas$SERVICE_AREA_LABEL<-as.character(finalserviceareas$SERVICE_AREA_LABEL) #make the column a character column
#   nrow(finalserviceareas) #140
#   
# # Parallelize the foreach loop
# 
#   detectCores() #4
#   cl<-makeCluster(4)
#   registerDoParallel(cl)
# 
# # Loop through each FIPSCODE in FIPScodes and bin cultures as inside or outside of them
# 
#   geocodedgoodcitiesdist$servicearea<-NA #create empty column
#   z<-nrow(finalserviceareas) #140 cities
#   
#   Old<-Sys.time()
#   export.names<-c("SpatialPoints","CRS", "gContains")
# 
# # Plot each shapefile individually and check addresses against it
# 
#   # Loop start 
#   Old<-Sys.time()
#   
#   for (i in 1:z){
#   
#   # plot the service area
#   
#   dsn<-getwd()
#   print(i)
#   #print(finalserviceareas$NAME[i])
#   #print(finalserviceareas$SERVICE_AREA_LABEL[i])
#   ogrInfo(dsn=dsn,layer=finalserviceareas$SERVICE_AREA_LABEL[i])
#   
#   # Read in shape file and specify projection
#   
#   suppressWarnings(hold<-readShapePoly(finalserviceareas$SERVICE_AREA_LABEL[i],proj4string=CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")))
# 
#   # Transform shape file
#   
#   hold<-spTransform(hold, CRS("+proj=longlat +datum=WGS84 +no_defs"))
#   
#   plot(hold)
#   
#   #loop through culture results and assign them to a service area
#   
#   #foreach returns a vector
#   
#   assignments<-foreach (q=1:nrow(geocodedgoodcitiesdist), .combine="c", .export=export.names) %dopar% {  #.combine will return a character vector instead of a list #which is the default in foreach
#   p<-SpatialPoints(list(geocodedgoodcitiesdist$geocode_lon[q],geocodedgoodcitiesdist$geocode_lat[q]),proj4string=CRS("+proj=longlat +datum=WGS84 +no_defs"))
#   if(gContains(hold,p)==TRUE){as.character(finalserviceareas$NAME[i])}
#   else {NA}
#   }
#   
#   newlyassigned<-which(!is.na(assignments))
#   
#   geocodedgoodcitiesdist$servicearea[newlyassigned]<-assignments[newlyassigned] #in the next iteration of the loop, only check cultures that haven't been assigned yet
# }
#   # Loop stop
#   stopCluster(cl)
# 
#   New<-Sys.time()
#   New-Old
#   
# # Rename file
#   #save<-geocodedgoodcitiesdist
#   geocodedgoodcitiesdistwater<-geocodedgoodcitiesdist #has servicearea assignments
#   
# # Check files
# 
#   nrow(filter(geocodedgoodcitiesdistwater, !is.na(servicearea))) #23259
#   nrow(filter(geocodedgoodcitiesdistwater, is.na(servicearea))) #1997 (8.6% unassigned)
#   length(unique(geocodedgoodcitiesdistwater$servicearea)) #141 service areas (140 not including NA)
#   
# # Output file with all assignments (inclduding NA)
# 
#   write.table(geocodedgoodcitiesdistwater,"geocodedgoodcitiesdistwater.txt", sep="\t")
#   
# # Read in file from previous run
   
  geocodedgoodcitiesdistwater<-read.table("geocodedgoodcitiesdistwater.txt", sep="\t")
  length(unique(geocodedgoodcitiesdistwater$sample_id)) #25256
  
# Remove records without assignments
  
  geocodedgoodcitiesdistwater<-filter(geocodedgoodcitiesdistwater, !is.na(servicearea)) #remove NA
  length(unique(geocodedgoodcitiesdistwater$sample_id)) #23259

```

## 7. Filter record addr by distance /records
```{r}
  
# Max distance traveled from chloramine city

  chloramine<-filter(geocodedgoodcitiesdistwater, 
                       servicearea=="Ann Arbor" | 
                       servicearea=="Lansing" | 
                       servicearea=="East Lansing") #chloramine cities
  nrow(chloramine)
  max(chloramine$distance) #112,973 m (70.2 mi)
  
# Filter for patients with distances less than or equal to 80 mi (128,748 m)
  
  geocodedgoodcitiesdistwaterclose<-filter(geocodedgoodcitiesdistwater, distance<128748 | distance==128748) 
  nrow(geocodedgoodcitiesdistwaterclose)                       #20,133
  length(unique(geocodedgoodcitiesdistwaterclose$servicearea)) #102 service areas


# Output file  
  
write.table(geocodedgoodcitiesdistwaterclose, "geocodedgoodcitiesdistwaterclose.txt")

# Read in from previous run
geocodedgoodcitiesdistwaterclose<-read.table("geocodedgoodcitiesdistwaterclose.txt", header=T)
length(unique(geocodedgoodcitiesdistwaterclose$sample_id)) #20,133
```
## 8. Remove Flint records from 2014-2015
```{r}
  
  # Get Flint record ids

  flint_sampleids<-filter(geocodedgoodcitiesdistwaterclose, servicearea=="Flint")
  flint_sampleids<-flint_sampleids$sample_id
  
  # Get Flint record ids from 2014-2015

  flintclinical<-filter(clinicalgood, sample_id %in% flint_sampleids)
  removeflintsampleids<-filter(flintclinical, sample_year==2014 | sample_year==2015)$sample_id
  length(removeflintsampleids) #75
  
  # Remove these from clinical file
  
  nrow(clinicalgood) #61009
  clinicalgoodflint<-filter(clinicalgood, !sample_id %in% removeflintsampleids)
  nrow(clinicalgoodflint) #60934 #75 records removed
  
```

## 9. Remove E. Lansing records from 2000
```{r}
  # Get East Lansing record ids

  eastlansingsampleids<-filter(geocodedgoodcitiesdistwaterclose, servicearea=="East Lansing")$sample_id #143
  
  # Get record ids from year 2000

  eastlansingclinical<-filter(clinicalgoodflint, sample_id %in% eastlansingsampleids)
  removeeastlansingsampleids<-filter(eastlansingclinical, sample_year==2000)$sample_id #year 2000 is when E. Lansing converted from chlorine to chloramine
  length(removeeastlansingsampleids) #3
  
  # Remove these from clinical file
  
  nrow(clinicalgoodflint) #60,934
  clinicalgoodflintlansing<-filter(clinicalgoodflint, !sample_id %in% removeeastlansingsampleids)
  nrow(clinicalgoodflintlansing) #60,931 #3 records removed
  
  
  clinicalgood<-clinicalgoodflintlansing #replace original file
  length(unique(clinicalgood$sample_id)) #60,931
```





## 10. Filtering done. Subset clinical file
```{r}

# Subset

  clinicalgoodsubset<-filter(clinicalgood, sample_id %in% geocodedgoodcitiesdistwaterclose$sample_id)
  nrow(clinicalgoodsubset) #20,055
  nrow(geocodedgoodcitiesdistwaterclose) #20,133 #78 off represents 75 flint and 3 E. lansing records removed from clinical file

# Add distance from geocoded file

  distcut<-select(geocodedgoodcitiesdistwaterclose, sample_id, distance)
  clinicalgoodsubset$sample_id<-as.character(clinicalgoodsubset$sample_id) #convert to character
  distcut$sample_id<-as.character(distcut$sample_id) #convert to character

  clinicalgoodsubsetdist<-right_join(distcut, clinicalgoodsubset, by="sample_id" )
  length(unique(clinicalgoodsubsetdist$sample_id)) #20,055 records
  
# Output
  
  #write.table(clinicalgoodsubsetdist, "clinicalgoodsubsetdist.txt")
  clinicalgoodsubsetdist<-read.table("clinicalgoodsubsetdist.txt")

```





















# Get cohort for modeling

## 1. Reduce dataset to patients /patients
```{r get_patients, echo=F, warning=F, include=F, eval=F}

  Old<-Sys.time()
 
# Get first positives
 
  positives<-filter(clinicalgoodsubsetdist, result=="1")
  nrow(positives) #892
  firstpositives<-do.call(rbind, unname(by(positives, positives$study_id, function(x) x[x$age == min(x$age),]))) #get first positives
  firstpositives<-firstpositives %>% group_by(study_id, sample_year, age) %>% filter(row_number()==1) #Remove duplicate first positives
  nrow(firstpositives) #468 first positives
  
# Get neverpositive patients

  positive_subject_ids<-unique(filter(clinicalgoodsubsetdist, result=="1")$study_id)
  negative_subject_ids<-unique(filter(clinicalgoodsubsetdist, result=="0")$study_id)
   
  positivewithnegative<-as.data.frame(intersect(positive_subject_ids, negative_subject_ids)) #patients with positive and negative records
  nrow(distinct(positivewithnegative)) #311 patients with positive and negative cultures
   
  neverpositive<-setdiff(negative_subject_ids, positive_subject_ids) #patients with negative cultures only
  length(neverpositive) #9,427
  negatives<-filter(clinicalgoodsubsetdist, study_id %in% neverpositive) #get negative cultures from neverpositive patients
  nrow(negatives) #17,840

# Randomly select a negative test for each neverpositive patient
 
  z<-length(neverpositive)
  randomlyselected<-NA
  Old<-Sys.time()
  for (i in 1:z){ #loop through each study id in negatives and randomly select a row
   hold<-filter(negatives, study_id==neverpositive[i])
   selected<-hold[sample(nrow(hold), 1), ] #sample is for random selection
   randomlyselected<-rbind(randomlyselected, selected)
  }
  
  New<-Sys.time()
  New-Old #Time difference of 1.387492 mins
   
# Format
   
  randomlyselected<-randomlyselected[2:nrow(randomlyselected),]
  rownames(randomlyselected)<-1:nrow(randomlyselected) #reset the rownames
  nrow(randomlyselected) #9,427 rows
 
# Combine firstpositives and randomlyselected negatives  
 
  firstpositivesrandomnegatives<-bind_rows(firstpositives, randomlyselected)
   
# Check files
   
  nrow(firstpositivesrandomnegatives) #9895 patients
  nrow(filter(firstpositivesrandomnegatives, result=="1")) #468 positive patients
  nrow(filter(firstpositivesrandomnegatives, result=="0")) #9,427 negative patients
   
# Output file
  
  #write.table(firstpositivesrandomnegatives, "firstpositivesrandomnegatives.txt", sep="\t")
  firstpositivesrandomnegatives<-read.table("firstpositivesrandomnegatives.txt")
  nrow(firstpositivesrandomnegatives) #9895
  
  # Get table of species for positives
   
   speciescounts<-filter(firstpositivesrandomnegatives, result==1) %>% group_by(species) %>% summarise(n = n())
   speciescounts$percent<-speciescounts$n/sum(speciescounts$n)*100
   speciescountstable<-speciescounts
   
   #write out table
   write.xlsx(as.data.frame(arrange(speciescountstable, desc(n))), "speciescountstable.xlsx")
   
   
  
   
```

## 2. Code records as from a predisposed patient (1) or not (0)
```{r assign_immune_status, echo=F, warning=F, include=F, eval=F}
  
Old<-Sys.time()

# Read in ICD codes

  ICDcodes<-read.table("ICDcodesused.txt", header=T)

# Read in patient diagnoses

  diagnoses<-read.csv("deided_diagnosis_codes.csv", header=T, row.names=1)
  length(unique(diagnoses$study_id)) #29,494 patients 
                                     #448 fewer patients than clinical file 
                                     #We did not have diagnoses codes for these 448
  
  
  #patients
  diagnoses$diagnosis_code<-as.character(diagnoses$diagnosis_code) #convert to character format
  
  
# Format diagnosis codes to make compatible with AHRQ ICD9 and ICD10 codes
  
  # Remove periods
    
  diagnoses$diagnosis_code_reformat<-sapply(diagnoses$diagnosis_code,function(x){gsub("[.]","",ignore.case=T,x)}) #remove periods

  # For numbers with 2 digits, add a leading zero
  
  for (i in 1:nrow(diagnoses)){
    if (nchar(diagnoses$diagnosis_code_reformat[i])==2){diagnoses$diagnosis_code_reformat[i]<-paste(0, diagnoses$diagnosis_code_reformat[i], sep="")}}

  diagnoses$diagnosis_code_reformat<-stri_pad_right(diagnoses$diagnosis_code_reformat, 5, "0") #add trailing zeros to make length 5

# Loop through unique study ids

  # Get unique study ids
  
  study_ids<-distinct(select(diagnoses, study_id))
  nrow(study_ids) #29,494 unique study ids

## Do nested for loop to code each specimen as from a predisposed patient or not
  
  z<-nrow(study_ids)
  Oldloop<-Sys.time()
  firstpositivesrandomnegatives$predisposed<-NA
  
  for (i in 1:z){ #loop through each study id
    print(i)
    study_id<-filter(diagnoses, study_id==study_ids[i,1]) #filter for all codes from a given study id
    year_codes<-select(study_id, encounter_year, diagnosis_code_reformat) #select year and codes columns
    #print(i)
    year_codes$predisposed<-NA
   
    for (q in 1:nrow(year_codes)){ #for each study id, loop through diagnosis codes
      #if(length(grep(codes[q], ICDcodes$ICD.code.reformat, ignore.case=T))>0){print("compromised")} else {print("nope")}
      if(length(grep(year_codes[q,2], ICDcodes$ICD.code.reformat, ignore.case=T))>0){year_codes$predisposed[q]<-"1"} else {year_codes$predisposed[q]<-"0"} #label the year with predisposed codes
    } 
    
    if(length(predisposed_years<-filter(year_codes, predisposed==1)$encounter_year)>0){ 
      year1<-unique(predisposed_years)-1 #a year preceding the predisposed year
      year2<-unique(predisposed_years) #the predisposed year
      year3<-unique(predisposed_years)+1 #one year after
      year4<-unique(predisposed_years)+2 #two years after
      predisposed_years<-c(year1,year2,year3,year4) #create vector of predisposed years

      firstpositivesrandomnegatives$predisposed[firstpositivesrandomnegatives$study_id==study_ids[i,1] & firstpositivesrandomnegatives$sample_year %in% predisposed_years]<-"1" #code the cultures from that year, the year prior and two years afterward as predisposed
    }
  }

  Newloop<-Sys.time()
  Newloop-Oldloop #20.51359 mins
  
  nrow(filter(firstpositivesrandomnegatives, predisposed=="1")) #3060 second time it was run
  unique(firstpositivesrandomnegatives$predisposed) #NA and 1
  
  firstpositivesrandomnegativespredisposed<-firstpositivesrandomnegatives #rename
  
  firstpositivesrandomnegativespredisposed[which(is.na(firstpositivesrandomnegativespredisposed$predisposed)),11]<-"0" #replace NA with 0

  nrow(filter(firstpositivesrandomnegativespredisposed, predisposed=="1"))/nrow(firstpositivesrandomnegativespredisposed) #30.9% patients predisposed
  nrow(filter(firstpositivesrandomnegativespredisposed, result=="1" & predisposed=="1"))/nrow(filter(firstpositivesrandomnegativespredisposed, result=="1")) #54.5% infected patients predisposed

# Output file
  
  #write.table(firstpositivesrandomnegativespredisposed,"firstpositivesrandomnegativespredisposed.txt")
  

# Read in from previous run
  
  firstpositivesrandomnegativespredisposed<-read.table("firstpositivesrandomnegativespredisposed.txt")

# Summary
nrow(filter(firstpositivesrandomnegativespredisposed, predisposed==1))/nrow(firstpositivesrandomnegativespredisposed) #30.9% predisposed

## Diagnoses for NTM positive patients
#  positives<- filter(firstpositivesrandomnegativespredisposed, result==1)
#  diagnosis_description<-select(diagnoses, diagnosis_code, diagnosis_description)
#  diagnosespositives<-filter(diagnoses, study_id %in% positives$study_id)
#  diagnosespositivescounts<-diagnosespositives %>% group_by(diagnosis_code) %>% summarise(n = n())
#  diagnosespositivescounts<-distinct(right_join(diagnosis_description, diagnosespositivescounts))
#  diagnosespositivescounts<-arrange(diagnosespositivescounts, desc(n))
  
  write.xlsx(diagnosespositivescounts, "diagnosespositivescounts.xlsx")
  



```



## 3. Add water treatment variables
```{r}

# Add servicearea assignments

  geocodedgoodcitiesdistwaterclosecut<-select(geocodedgoodcitiesdistwaterclose, sample_id, servicearea)
  firstpositivesrandomnegativespredisposed$sample_id<- as.character(firstpositivesrandomnegativespredisposed$sample_id) #make character
  geocodedgoodcitiesdistwaterclosecut$sample_id<- as.character(geocodedgoodcitiesdistwaterclosecut$sample_id) #make character
  firstposandnegpredisposedservicearea<-right_join(geocodedgoodcitiesdistwaterclosecut, firstpositivesrandomnegativespredisposed, by="sample_id") #join service areas into patients dataset

# Add disinfectant, source water, source water assessment
  
  finalserviceareas<-read.table("finalserviceareas.txt")
  finalserviceareascut<-select(finalserviceareas, NAME, PRIMARY_SOURCE_CODE, SOURCE_WATER_ASSESSMENT, TREATMENT_PROCESS) #select columns
  colnames(finalserviceareascut)[1]<-"servicearea" #rename column 1

  firstposandnegpredisposedserviceareawater<-right_join(finalserviceareascut, firstposandnegpredisposedservicearea, by="servicearea") 

# Make disinfectant binary (chloramines is 1 and chlorine is 0)
  
  firstposandnegpredisposedserviceareawater$TREATMENT_PROCESS<-sapply(firstposandnegpredisposedserviceareawater$TREATMENT_PROCESS,function(x){gsub("Chloramines","1",ignore.case=T,x)}) #make binary
  firstposandnegpredisposedserviceareawater$TREATMENT_PROCESS<-sapply(firstposandnegpredisposedserviceareawater$TREATMENT_PROCESS,function(x){gsub("Chlorine","0",ignore.case=T,x)}) #make binary
  firstposandnegpredisposedserviceareawater$TREATMENT_PROCESS<-as.factor(firstposandnegpredisposedserviceareawater$TREATMENT_PROCESS) #make factor

# Output file
  
  #write.table(firstposandnegpredisposedserviceareawater, "firstposandnegpredisposedserviceareawater.txt")
  #read in file from previous run
  firstposandnegpredisposedserviceareawater<-read.table("firstposandnegpredisposedserviceareawater.txt", header=T)
  nrow(firstposandnegpredisposedserviceareawater) #9895
```

## 4. Add other city variables
```{r}

# Get city pop density, median income, percent white, median age data from 2010 US Census

  # Population density
  
  pop_density<-read.csv("POP_DENSITY.csv", header=TRUE)
  pop_density<-separate(pop_density, Geography, c("Minor", "County"), sep=",") #separate geography into minor (city/township), County and State
  pop_density<-select(pop_density, Minor, County, Population, Pop_density_per_sq_mi_land_area)
  pop_density<-na.omit(pop_density)
  pop_density<-(pop_density %>% group_by(Minor) %>% summarise(max_pop_density=max(Pop_density_per_sq_mi_land_area))) #Take max value if multiple rows for a city
  nrow(pop_density)
  length(unique(pop_density$Minor))

  # Median household income
  
  medincome<-read.csv("MEDIAN_HOUSEHOLD_INCOME.csv", header=TRUE)
  medincome<-separate(medincome, Geography, c("Minor", "County", "State"), sep=",") #separate geography into minor (city/township), County and State
  medincome<-select(medincome, Minor, County, Estimate_2015_dollars)
  medincome$Estimate_2015_dollars<-as.numeric(as.character(medincome$Estimate_2015_dollars))
  medincome<-filter(medincome, !is.na(Estimate_2015_dollars))
  medincome<-na.omit(medincome)
  medincome<-medincome %>% group_by(Minor) %>% summarise(max_income=max(Estimate_2015_dollars)) #Take max value if multiple rows for a city
  nrow(medincome)
  length(unique(medincome$Minor))
  
  # Percent white
  
  race<-read.csv("RACE_AND_HISPANIC_OR_LATINO_ORIGIN.csv", header=TRUE)
  race<-separate(race, Geography, c("Minor", "County", "State"), sep=",") #separate geography into minor (city/township), County and State
  race<-select(race, Minor, Percent..RACE...Total.population...One.race...White)
  colnames(race)<-c("Minor", "Percent_white")
  race$Percent_white<-as.character(race$Percent_white)
  race$Percent_white<-as.numeric(race$Percent_white)
  race<-na.omit(race) #remove NAs
  race<-race %>% group_by(Minor) %>% summarise(Percent_white=max(Percent_white))

  # Percent pop over 65 years old
  
  percent_age<-read.csv("PERCENT_AGE.csv", header=TRUE)
  percent_age<-separate(percent_age, Geography, c("Minor", "County", "State"), sep=",") #separate geography into minor (city/township), County and State
  percent_age<-select(percent_age, Minor, Sum) #keep percent population above 65 years old
  percent_age<-na.omit(percent_age)
  percent_age<-percent_age %>% group_by(Minor) %>% summarise(max_percent_above_65_years_old=max(Sum))
  nrow(percent_age)
  length(unique(percent_age$Minor))

# Rename Dexter township as Dexter city because the township became a city in 2014
  pop_density$Minor<-sapply(pop_density$Minor,function(x){gsub("Dexter township","Dexter city",ignore.case=T,x)})
  medincome$Minor<-sapply(medincome$Minor,function(x){gsub("Dexter township","Dexter city",ignore.case=T,x)})
  race$Minor<-sapply(race$Minor,function(x){gsub("Dexter township","Dexter city",ignore.case=T,x)})
  percent_age$Minor<-sapply(percent_age$Minor,function(x){gsub("Dexter township","Dexter city",ignore.case=T,x)})

# Join files
  # Create a Minor column
  firstposandnegpredisposedserviceareawater$Minor<-paste(firstposandnegpredisposedserviceareawater$servicearea, "city", sep=" ") #add city

  # Format some city names
    
  firstposandnegpredisposedserviceareawater$Minor<-sapply(firstposandnegpredisposedserviceareawater$Minor,function(x){gsub("St Clair Shores","St. Clair Shores",ignore.case=T,x)})
  firstposandnegpredisposedserviceareawater$Minor<-sapply(firstposandnegpredisposedserviceareawater$Minor,function(x){gsub("Mt Clemens","Mount Clemens",ignore.case=T,x)})
    firstposandnegpredisposedserviceareawater$Minor<-sapply(firstposandnegpredisposedserviceareawater$Minor,function(x){gsub("The Village of Grosse Pointe Shores A Michigan City","Village of Grosse Pointe Shores",ignore.case=T,x)})
  
  firstposandneg.predisposed.servicearea.water<-firstposandnegpredisposedserviceareawater #rename file for legibility
  
  # Join
  firstposandneg.predisposed.servicearea.water.pop<-right_join(pop_density, firstposandneg.predisposed.servicearea.water, by="Minor") #pop density
  firstposandneg.predisposed.servicearea.water.pop.income<-right_join(medincome, firstposandneg.predisposed.servicearea.water.pop, by="Minor") #median income
  firstposandneg.predisposed.servicearea.water.pop.income.race<-right_join(race, firstposandneg.predisposed.servicearea.water.pop.income, by="Minor") #percent black
  firstposandneg.predisposed.servicearea.water.pop.income.race.age<-right_join(percent_age,firstposandneg.predisposed.servicearea.water.pop.income.race, by="Minor") #age
  
  nrow(firstposandneg.predisposed.servicearea.water.pop.income.race.age) #9895

```





## 5. Summarize the cohort
```{r}
   tosummarize<-firstposandneg.predisposed.servicearea.water.pop.income.race.age
   tosummarizepositives<-filter(tosummarize, result==1)
   tosummarizenegatives<-filter(tosummarize, result==0)
   
   mean(tosummarize$age) #50.7
   sd(tosummarize$age) #21.7
   
   mean(tosummarizepositives$age)
   sd(tosummarizepositives$age)
   
   mean(tosummarizenegatives$age)
   sd(tosummarizenegatives$age)

   # get source groups for positive patients
   sourcecounts<-filter(tosummarize, result==1) %>% group_by(source_group) %>% summarise(n = n())
   sourcecounts$percent<-sourcecounts$n/sum(sourcecounts$n)*100
   sourcegrouptable<-sourcecounts


#predisposed

      predisposed<-tosummarize %>% group_by(predisposed) %>% summarise(n = n())
      predisposed$percent<-predisposed$n/sum(predisposed$n)*100
  
      predisposedpos<-tosummarizepositives %>% group_by(predisposed) %>% summarise(n = n())
      predisposedpos$percent<-predisposedpos$n/sum(predisposedpos$n)*100
      
      predisposedneg<-tosummarizenegatives %>% group_by(predisposed) %>% summarise(n = n())
      predisposedneg$percent<-predisposedneg$n/sum(predisposedneg$n)*100
      
      #54.5% of NTM positive patients were predisposed for NTM infection
      #29.8% of NTM negative patients were predisposed for NTM infection
      

#sex
      sex<-tosummarize %>% group_by(sex) %>% summarise(n = n())
      sex$percent<-sex$n/sum(sex$n)*100
      
      sexpos<-tosummarizepositives %>% group_by(sex) %>% summarise(n = n())
      sexpos$percent<-sexpos$n/sum(sexpos$n)*100
      
      sexneg<-tosummarizenegatives %>% group_by(sex) %>% summarise(n = n())
      sexneg$percent<-sexneg$n/sum(sexneg$n)*100
      
#disinfectant
   
      disinfectant<-tosummarize %>% group_by(TREATMENT_PROCESS) %>% summarise(n = n())
      disinfectant$percent<-disinfectant$n/sum(disinfectant$n)*100
      
      disinfectantpos<-tosummarizepositives %>% group_by(TREATMENT_PROCESS) %>% summarise(n = n())
      disinfectantpos$percent<-disinfectantpos$n/sum(disinfectantpos$n)*100
      
      disinfectantneg<-tosummarizenegatives %>% group_by(TREATMENT_PROCESS) %>% summarise(n = n())
      disinfectantneg$percent<-disinfectantneg$n/sum(disinfectantneg$n)*100
      
#surface

   
      surfacewater<-tosummarize %>% group_by(PRIMARY_SOURCE_CODE) %>% summarise(n = n())
      surfacewater$percent<-surfacewater$n/sum(surfacewater$n)*100
      
      surfacewaterpos<-tosummarizepositives %>% group_by(PRIMARY_SOURCE_CODE) %>% summarise(n = n())
      surfacewaterpos$percent<-surfacewaterpos$n/sum(surfacewaterpos$n)*100
      
      surfacewaterneg<-tosummarizenegatives %>% group_by(PRIMARY_SOURCE_CODE) %>% summarise(n = n())
      surfacewaterneg$percent<-surfacewaterneg$n/sum(surfacewaterneg$n)*100

```

# Modeling
## 1. glm model
```{r}
 # Make df for modeling

  formod<-select(firstposandneg.predisposed.servicearea.water.pop.income.race.age, #select specific columns
                   distance, 
                   max_percent_above_65_years_old, 
                   Percent_white, 
                   max_income, 
                   max_pop_density, 
                   servicearea, 
                   PRIMARY_SOURCE_CODE, 
                   TREATMENT_PROCESS, 
                   sample_id, 
                   study_id, 
                   result, 
                   sample_year, 
                   sex, 
                   age, 
                   predisposed) 

# Rename columns

  colnames(formod)<-c("distance",
                        "percent_above_65_years_old", 
                        "percent_white", 
                        "med_income", 
                        "pop_density", 
                        "servicearea", 
                        "source_water", 
                        "disinfectant", 
                        "sample_id",
                        "study_id", 
                        "result", 
                        "sample_year", 
                        "sex", 
                        "age", 
                        "predisposed")
  
# check for NAs

  nrow(formod)                    #9895
  formod <- na.omit(formod)       #remove NAs
  nrow(formod)                    #9895
  nrow(filter(formod, result==1)) #468 positives
  nrow(filter(formod, result==0)) #9427 negatives
  
  #write.table(formod, "formod.txt")
  #formod<-read.table("formod.txt")
  

  
########### glm model

    mod<-glm(result ~ age + sex + predisposed             #individual characteristics
         + log(med_income) 
         + percent_white 
         + pop_density 
         + percent_above_65_years_old                     #other city variables
         + disinfectant + source_water                    #water variables of interest
         + sample_year + distance,                        #other variables
         data=formod,
         family="binomial")
  
         summary(mod)
         
         AIC(mod) #3627.15
    
#Coefficients:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                 3.178e+01  2.159e+01   1.472  0.14097    
#age                         6.368e-03  2.389e-03   2.665  0.00769 ** significant
#sexM                       -1.777e-01  9.609e-02  -1.849  0.06443 .  
#predisposed                 1.079e+00  9.739e-02  11.082  < 2e-16 *** very significant
#log(med_income)             1.818e-01  2.170e-01   0.838  0.40220    
#percent_white               5.950e-03  3.190e-03   1.865  0.06212 .  
#pop_density                 9.257e-05  4.620e-05   2.004  0.04510 *  
#percent_above_65_years_old -8.634e-03  1.831e-02  -0.472  0.63722    
#disinfectant                2.023e-01  1.671e-01   1.211  0.22598    
#source_waterSW              3.785e-01  1.793e-01   2.111  0.03477 * < 0.05  
#sample_year                -1.915e-02  1.070e-02  -1.790  0.07349 .  
#distance                   -4.762e-07  2.143e-06  -0.222  0.82420  


########### Model with interacting terms
       
#disinfectant*source_water
       
    mod<-glm(result ~ age + sex + predisposed                 #individual characteristics
         + log(med_income) 
         + percent_white 
         + pop_density 
         + percent_above_65_years_old                         #other city variables
         + disinfectant*source_water                          #water variables of interest
         + sample_year + distance,                            #other variables
         data=formod,
         family="binomial")
  
         summary(mod)
         
         AIC(mod) #3629.041 #Interacting disinfectant and source water doesn't improve model
         
#pop_density*source_Water
         
    mod<-glm(result ~ age + sex + predisposed                 #individual characteristics
         + log(med_income) 
         + percent_white 
         + percent_above_65_years_old                         #other city variables
         + disinfectant
         + pop_density*source_water
         + sample_year + distance,                            #other variables
         data=formod,
         family="binomial")
      
      summary(mod)
             
      AIC(mod) #3628.144 #Interacting population density and source water type does't improve model



  mod<-glm(result ~ age*predisposed + sex #individual characteristics
      + log(med_income) 
      + percent_white 
      + percent_above_65_years_old #other city variables
      + pop_density 
      + source_water
      + disinfectant
      + sample_year 
      + distance, #other variables
      data=formod,
      family="binomial") #model fit
      
      summary(mod)
      AIC(mod) #3619.083 #Improves the model
      
      
      
#Coefficients:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                 3.163e+01  2.160e+01   1.464  0.14321    
#age(when not predisposed)   1.369e-02  3.403e-03   4.022 5.77e-05 *** Odds ratio 1.01
#predisposed                 1.897e+00  1.897e+00   6.849 7.44e-12 *** Odds ratio 6.67, very high?
#sexM                       -1.779e-01  9.611e-02  -1.851  0.06419 .   Odds ratio 0.84  
#log(med_income)             1.691e-01  2.171e-01   0.779  0.43611    
#percent_white               6.021e-03  3.186e-03   1.890  0.05881 .   Odds ratio 1.006  
#percent_above_65_years_old -8.528e-03  1.826e-02  -0.467  0.64055    
#source_waterSW              3.743e-01  1.789e-01   2.092  0.03644 *   Odds ratio 1.45
#disinfectant                1.946e-01  1.673e-01   1.163  0.24477    
#pop_density                 8.682e-05  4.624e-05   1.877  0.06047 .   Odds ratio 1.000087
#sample_year                -1.919e-02  1.071e-02  -1.792  0.07318 .   Odds ratio 0.98
#distance                   -8.803e-07  2.151e-06  -0.409  0.68229    
#age:predisposed            -1.501e-02  4.740e-03  -3.167  0.00154 **

oddsratios<-exp(mod$coefficients) #odds ratios
as.data.frame(oddsratios)
#                             oddsratios
#(Intercept)                5.432673e+13
#age                        1.013782e+00
#predisposed                6.667568e+00
#sexM                       8.370299e-01
#log(med_income)            1.184229e+00
#percent_white              1.006039e+00
#percent_above_65_years_old 9.915080e-01
#pop_density                1.000087e+00
#source_waterSW             1.454017e+00
#disinfectant               1.214865e+00
#sample_year                9.809958e-01
#distance                   9.999991e-01
#age:predisposed            9.851026e-01

exp(confint(mod))

#                                  2.5 %       97.5 %
#(Intercept)                2.109299e-05 1.306702e+32
#age                        1.007138e+00 1.020673e+00
#predisposed                3.882317e+00 1.151447e+01
#sexM                       6.931188e-01 1.010491e+00
#log(med_income)            7.694757e-01 1.803280e+00
#percent_white              9.998691e-01 1.012449e+00
#percent_above_65_years_old 9.550539e-01 1.025690e+00
#pop_density                9.999960e-01 1.000177e+00
#source_waterSW             1.032134e+00 2.083886e+00
#disinfectant               8.728720e-01 1.682205e+00
#sample_year                9.606271e-01 1.001828e+00
#distance                   9.999949e-01 1.000003e+00
#age:predisposed            9.759708e-01 9.942832e-01


```

## 2. Propensity score matching
```{r matching}

# Exact match

  e <- exactMatch(disinfectant ~ 
                    predisposed + 
                    sex + 
                    source_water, 
                  data = formod) #exact matching


# Calipers
  
  # 1. age
  # The caliper is done in two steps, first we create the distance matrix
  dm1 <- match_on(disinfectant ~ age, method = "euclidean", data = formod, within = e) #within exact matches
  c1 <- caliper(dm1, 10) #caliper of 10 years of age
  
  # 2. distance
  # The caliper is done in two steps, first we create the distance matrix
  dm2 <- match_on(disinfectant ~ distance, method = "euclidean", data = formod, within = c1)
  c2 <- caliper(dm2, 16093) #16093 m is approx. 10 mi #caliper of 10 miles
  

#Estimate propensity scores (this is the same glm model as above but now modeling disinfectant as a function of all other covariates)
  match<-glm(disinfectant ~ age*predisposed + sex  #patient characteristics
      + log(med_income) #city variables
      + percent_white 
      + percent_above_65_years_old
      + pop_density 
      + source_water
      + sample_year #other record-specific variables
      + distance, 
      data=formod,
      family="binomial") #model fit
  #warning: glm.fit: fitted probabilities numerically 0 or 1 occurred 
  

  
  formod$pr_score<-predict(match, type="response", newdata=formod)  #newdata call to predict using entire dataset
  
  m2 <- match_on(disinfectant ~ pr_score,
                within = c2, #exact match and calipers
                data = formod)
  summary(m2)


# Full matching

  # Without constraints
  
  p <- fullmatch(m2, data = formod)#minimum number of controls per matched treatment
  summary(p)



```
## 3. Subset for matched patients
```{r}
# Subset formod for the matched data

formod$ismatched<-!is.na(p)
matcheddat<-filter(formod, ismatched=="TRUE")
nrow(matcheddat) #2736

#2736 patients


#to summarize disinfectant and source water for the 2,736 matched patients

#disinfectant
   
      disinfectant<-matcheddat %>% group_by(disinfectant) %>% summarise(n = n())
      disinfectant$percent<-disinfectant$n/sum(disinfectant$n)*100
      
      matcheddatpositives<-filter(matcheddat, result==1)
      disinfectantpos<-matcheddatpositives %>% group_by(disinfectant) %>% summarise(n = n())
      disinfectantpos$percent<-disinfectantpos$n/sum(disinfectantpos$n)*100
      
      matcheddatnegatives<-filter(matcheddat, result==0)
      disinfectantneg<-matcheddatnegatives %>% group_by(disinfectant) %>% summarise(n = n())
      disinfectantneg$percent<-disinfectantneg$n/sum(disinfectantneg$n)*100
      
#surface

   
      surfacewater<-matcheddat %>% group_by(source_water) %>% summarise(n = n())
      surfacewater$percent<-surfacewater$n/sum(surfacewater$n)*100
      
      surfacewaterpos<-matcheddatpositives %>% group_by(source_water) %>% summarise(n = n())
      surfacewaterpos$percent<-surfacewaterpos$n/sum(surfacewaterpos$n)*100
      
      surfacewaterneg<-matcheddatnegatives %>% group_by(source_water) %>% summarise(n = n())
      surfacewaterneg$percent<-surfacewaterneg$n/sum(surfacewaterneg$n)*100


```

## 4. glm model with matched patients

```{r}


  matchedmod<-glm(result ~ age*predisposed + sex #individual characteristics
      + log(med_income) #city variables
      + percent_white 
      + percent_above_65_years_old
      + pop_density
      + source_water
      + disinfectant
      + sample_year #other variables
      + distance, 
      data=matcheddat,
      family="binomial")
      
      summary(matchedmod)
      AIC(matchedmod) #1091.836 #lowest AIC

      
#Coefficients:
#                             Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                 7.528e+00  4.143e+01   0.182 0.855815    
#age                         1.616e-02  5.712e-03   2.830 0.004660 ** 
#predisposed                 1.852e+00  5.472e-01   3.385 0.000713 ***
#sexM                       -1.574e-01  1.759e-01  -0.895 0.370943    
#log(med_income)            -2.862e-01  1.608e+00  -0.178 0.858685    
#percent_white               2.553e-02  3.113e-02   0.820 0.412056    
#percent_above_65_years_old -5.393e-02  6.993e-02  -0.771 0.440615    
#source_waterSW              1.510e+00  2.638e+00   0.572 0.567139    
#pop_density                 5.451e-05  3.579e-04   0.152 0.878955    
#disinfectant                3.664e-01  7.425e-01   0.493 0.621669    
#sample_year                -5.890e-03  1.942e-02  -0.303 0.761729    
#distance                    9.010e-06  2.662e-05   0.338 0.735011    
#age:predisposed            -1.379e-02  8.987e-03  -1.534 0.125055  

      oddsratios<-exp(matchedmod$coefficients)
      as.data.frame(oddsratios)
      
#                             oddsratios
#(Intercept)                1858.8687848
#age                           1.0162928
#predisposed                   6.3733652
#sexM                          0.8543877
#log(med_income)               0.7510923
#percent_white                 1.0258631
#percent_above_65_years_old    0.9474980
#source_waterSW                4.5259389
#pop_density                   1.0000545
#disinfectant                  1.4425842
#sample_year                   0.9941277
#distance                      1.0000090
#age:predisposed               0.9863091
      
exp(confint(matchedmod))

#                                  2.5 %       97.5 %
#(Intercept)                9.996746e-33 4.437156e+38
#age                        1.005221e+00 1.028021e+00
#predisposed                2.154410e+00 1.855186e+01
#sexM                       6.041331e-01 1.205422e+00
#log(med_income)            2.369635e-02 1.476203e+01
#percent_white              9.650455e-01 1.092968e+00
#percent_above_65_years_old 7.375396e-01 1.037314e+00
#source_waterSW             2.702940e-02 9.987565e+02
#pop_density                9.992863e-01 1.000800e+00
#disinfectant               3.609427e-01 6.965495e+00
#sample_year                9.570631e-01 1.032886e+00
#distance                   9.999567e-01 1.000063e+00
#age:predisposed            9.691289e-01 1.003939e+00
            
      
```
